<div class="mx-auto w-full max-w-md overflow-hidden rounded-sm bg-white shadow-lg">
  <div
    class="px-2 pt-3 pb-4 bg-no-repeat bg-cover bg-center"
    style="background-image: url('/assets/images/header-booking.png')"
  >
    <div class="flex items-center justify-center gap-2">
      <img src="/assets/images/nokair-logo.png" alt="Nok Air" class="h-7 w-auto" />
    </div>
    <div class="mt-3 py-4">
      <div class="relative mx-auto max-w-md">
        <div class="relative grid grid-cols-4 justify-items-center">
          <div
            class="absolute left-[12.5%] right-[12.5%] top-4 z-0 border-t border-dashed border-[#b18a00]"
          ></div>

          <div class="relative z-10 flex flex-col items-center gap-2">
            <div
              class="flex h-8 w-8 items-center justify-center rounded-full bg-[#4c4c4c] text-lg font-semibold text-white"
            >
              1
            </div>
            <span class="text-sm font-semibold text-[#303030]">กรอกข้อมูล</span>
          </div>

          <div class="relative z-10 flex flex-col items-center gap-2">
            <div
              class="flex h-8 w-8 items-center justify-center rounded-full border-2 border-[#b18a00] bg-[#FFCB08] text-lg font-semibold text-[#b18a00]"
            >
              2
            </div>
            <span class="text-sm font-semibold text-[#b18a00]">เลือกที่นั่ง</span>
          </div>

          <div class="relative z-10 flex flex-col items-center gap-2">
            <div
              class="flex h-8 w-8 items-center justify-center rounded-full border-2 border-[#b18a00] bg-[#FFCB08] text-lg font-semibold text-[#b18a00]"
            >
              3
            </div>
            <span class="text-sm font-semibold text-[#b18a00]">ตรวจสอบข้อมูล</span>
          </div>

          <div class="relative z-10 flex flex-col items-center gap-2">
            <div
              class="flex h-8 w-8 items-center justify-center rounded-full border-2 border-[#b18a00] bg-[#FFCB08] text-lg font-semibold text-[#b18a00]"
            >
              4
            </div>
            <span class="text-sm font-semibold text-[#b18a00]">ยืนยันชำระเงิน</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="flex gap-2 overflow-x-auto no-scrollbar border-b border-[#ededed] bg-white px-3 py-3">
    @for (tab of passengerTabs; track tab; let idx = $index) {
      <button
        type="button"
        class="min-w-[110px] rounded border px-3 py-2 text-sm"
        [disabled]="!isPassengerUnlocked(idx + 1)"
        [ngClass]="
          isPassengerCompleted(idx + 1)
            ? 'border-[#95d5a8] bg-[#e8f9ee] text-[#157a33]'
            : idx + 1 === currentPassenger
              ? 'border-[#ffd400] bg-[#fff7cf] text-[#1f1f1f]'
              : isPassengerUnlocked(idx + 1)
                ? 'border-[#dcdcdc] bg-white text-[#575757]'
                : 'border-[#ececec] bg-[#f8f8f8] text-[#a7a7a7]'
        "
        (click)="onSelectPassenger(idx + 1)"
      >
        {{ tab }}
      </button>
    }
  </div>

  <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()" class="px-4 py-4">
    <h2 class="font-bold">Passenger {{ currentPassenger }} (Primary passenger)</h2>
    <h3 class="font-medium">General Information</h3>

    <div class="mt-4 space-y-2">
      <hlm-form-field>
        <brn-select class="inline-block w-full" placeholder="Title *" formControlName="title">
          <hlm-select-trigger class="w-full">
            <hlm-select-value />
          </hlm-select-trigger>

          <hlm-select-content>
            <hlm-select-label>Title</hlm-select-label>
            @for (option of titleOptions; track option) {
              <hlm-option [value]="option">{{ option }}</hlm-option>
            }
          </hlm-select-content>
        </brn-select>
        @if (isInvalid('title')) {
          <hlm-error>Title is required.</hlm-error>
        }
      </hlm-form-field>

      <hlm-form-field>
        <input
          id="firstName"
          hlmInput
          formControlName="firstName"
          placeholder="First Name (English) *"
        />
        @if (isInvalid('firstName')) {
          <hlm-error>First name is required and must be English letters only.</hlm-error>
        }
      </hlm-form-field>

      <!-- Middle Name -->
      <hlm-form-field>
        <input
          id="middleName"
          hlmInput
          formControlName="middleName"
          placeholder="Middle Name (English)"
        />
        @if (isInvalid('middleName')) {
          <hlm-error>Middle name must be English letters only.</hlm-error>
        }
      </hlm-form-field>

      <!-- Last Name -->
      <hlm-form-field>
        <input
          id="lastName"
          hlmInput
          formControlName="lastName"
          placeholder="Last Name (English) *"
        />
        @if (isInvalid('lastName')) {
          <hlm-error>Last name is required and must be English letters only.</hlm-error>
        }
      </hlm-form-field>

      <div class="mt-2 flex flex-col gap-2">
        <hlm-date-picker
          buttonId="dateOfBirth"
          [autoCloseOnSelect]="true"
          formControlName="dateOfBirth"
          class="w-full"
        >
          <span class=" ">Select date</span>
        </hlm-date-picker>

        @if (isInvalid('dateOfBirth')) {
          <hlm-error>Date of birth is required.</hlm-error>
        }
      </div>
    </div>

    <h3 class="mt-4 font-medium">Passport Information</h3>

    <div class="mt-4 space-y-2">
      <div class="grid grid-cols-[120px_minmax(0,1fr)] gap-3">
        <hlm-form-field>
          <brn-select
            class="inline-block w-full"
            placeholder="Nationality *"
            formControlName="nationality"
          >
            <hlm-select-trigger
              class="w-full"
              brnSelectBottomSheetTrigger
              [openBottomSheet]="openNationalitySheet"
            >
              <hlm-select-value />
            </hlm-select-trigger>

            <hlm-select-content>
              @for (nationality of nationalities; track nationality) {
                <hlm-option [value]="nationality">{{ nationality }}</hlm-option>
              }
            </hlm-select-content>
          </brn-select>

          @if (isInvalid('nationality')) {
            <hlm-error>Nationality is required.</hlm-error>
          }
        </hlm-form-field>

        <hlm-form-field>
          <brn-select
            class="inline-block w-full"
            placeholder="Country of residence *"
            formControlName="countryOfResidence"
          >
            <hlm-select-trigger
              class="w-full"
              brnSelectBottomSheetTrigger
              [openBottomSheet]="openCountryResidenceSheet"
            >
              <hlm-select-value />
            </hlm-select-trigger>

            <hlm-select-content>
              @for (country of countries; track country) {
                <hlm-option [value]="country">{{ country }}</hlm-option>
              }
            </hlm-select-content>
          </brn-select>

          @if (isInvalid('countryOfResidence')) {
            <hlm-error>Country of residence is required.</hlm-error>
          }
        </hlm-form-field>
      </div>

      <hlm-form-field>
        <input
          id="passportNumber"
          hlmInput
          formControlName="passportNumber"
          placeholder="Passport Number *"
        />
        @if (isInvalid('passportNumber')) {
          <hlm-error>Passport number is required (6–12 A–Z / 0–9).</hlm-error>
        }
      </hlm-form-field>

      <!-- Issued By (select -> brn-select) -->
      <hlm-form-field>
        <brn-select
          class="inline-block w-full"
          placeholder="Issued By *"
          formControlName="issuedBy"
        >
          <hlm-select-trigger
            class="w-full"
            brnSelectBottomSheetTrigger
            [openBottomSheet]="openIssuedBySheet"
          >
            <hlm-select-value />
          </hlm-select-trigger>

          <hlm-select-content>
            @for (country of countries; track country) {
              <hlm-option [value]="country">{{ country }}</hlm-option>
            }
          </hlm-select-content>
        </brn-select>

        @if (isInvalid('issuedBy')) {
          <hlm-error>Issued by is required.</hlm-error>
        }
      </hlm-form-field>

      <!-- Passport Expiry Date -->
      <!-- <hlm-form-field>
        <hlm-date-picker
          buttonId="passportExpiryDate"
          formControlName="passportExpiryDate"
          class="w-full"
        >
          <span>Passport expiry date *</span>
        </hlm-date-picker>

        @if (isInvalid('passportExpiryDate')) {
          <hlm-error>Passport expiry date is required.</hlm-error>
        }
      </hlm-form-field> -->
      <div class="mt-2 flex flex-col gap-2">
        <hlm-date-picker
          buttonId="passportExpiryDate"
          [autoCloseOnSelect]="true"
          formControlName="passportExpiryDate"
          class="w-full"
        >
          <span class=" ">Select date</span>
        </hlm-date-picker>
        @if (isInvalid('passportExpiryDate')) {
          <hlm-error>Passport expiry date is required.</hlm-error>
        }
      </div>
    </div>

    <h3 class="mt-4 font-medium">Contact Information</h3>

    <div class="mt-4 space-y-2">
      <div class="grid grid-cols-[120px_1fr] gap-3">
        <!-- Mobile Country Code (select -> brn-select) -->
        <hlm-form-field>
          <brn-select
            class="inline-block w-full"
            placeholder="Code *"
            formControlName="mobileCountryCode"
          >
            <hlm-select-trigger
              class="w-full"
              brnSelectBottomSheetTrigger
              [openBottomSheet]="openMobileCodeSheet"
            >
              <hlm-select-value />
            </hlm-select-trigger>

            <hlm-select-content>
              @for (code of mobileCountryCodes; track code) {
                <hlm-option [value]="code">{{ code }}</hlm-option>
              }
            </hlm-select-content>
          </brn-select>

          @if (isInvalid('mobileCountryCode')) {
            <hlm-error>Mobile code is required.</hlm-error>
          }
        </hlm-form-field>

        <!-- Mobile Number -->
        <hlm-form-field>
          <input
            id="mobileNumber"
            hlmInput
            formControlName="mobileNumber"
            placeholder="Mobile Number *"
          />
          @if (isInvalid('mobileNumber')) {
            <hlm-error>Mobile number is required (8–15 digits).</hlm-error>
          }
        </hlm-form-field>
      </div>

      <!-- Email -->
      <hlm-form-field>
        <input id="email" hlmInput formControlName="email" placeholder="Email *" />
        @if (isInvalid('email')) {
          <hlm-error>The email is required and must be valid.</hlm-error>
        }
      </hlm-form-field>
    </div>

    <!-- ✅ Bundle selection (ตามดีไซน์) -->
    <div class="mt-4 space-y-4">
      @for (section of bundleSections; track section.direction) {
        <div>
          <div class="flex items-baseline gap-2">
            <h3 class="text-lg font-bold text-[#1f1f1f]">
              {{ section.titleTh }}
            </h3>
            <span class="text-lg text-[#9b9b9b]">| {{ section.subtitleEn }}</span>
          </div>

          <div class="mt-2 space-y-2 bg-white">
            @for (b of section.bundles; track b.code) {
              <button
                type="button"
                class="w-full rounded-lg border bg-white px-3 py-3 text-left transition"
                [ngClass]="
                  isBundleSelected(section.direction, b.code)
                    ? 'border-2 border-yellow-400 bg-yellow-50'
                    : 'border-gray-300'
                "
                (click)="selectBundle(section.direction, b.code)"
              >
                <div class="flex items-center gap-3">
                  <img [src]="b.iconUrl" [alt]="b.titleTh" class="h-9 w-9 flex-none" />

                  <div class="min-w-0 flex-1">
                    <div class="text-lg font-semibold text-[#1f1f1f] leading-tight">
                      {{ b.titleTh }}
                    </div>
                  </div>

                  <div class="text-right">
                    <div class="text-md font-bold text-[#1f1f1f]">{{ formatTHB(b.sale) }} THB</div>
                    <div class="flex items-center justify-end gap-1">
                      <span class="text-sm text-[#9b9b9b] line-through">
                        {{ formatTHB(b.original) }} THB
                      </span>
                      <span class="rounded bg-[#ffe7a3] px-1 text-sm font-semibold text-[#7a5a00]">
                        -{{ b.discountPercent }}%
                      </span>
                    </div>
                  </div>
                </div>

                @if (isBundleSelected(section.direction, b.code) && b.descriptions.length) {
                  <div class="mt-2 border-t border-[#e9e9e9] pt-2">
                    <ul class="space-y-1 text-xs text-[#6b6b6b]">
                      @for (d of b.descriptions; track d) {
                        <li class="flex gap-2 items-center">
                          <ng-icon
                            name="lucideCheckCircle2"
                            class="flex-none"
                            size="20"
                            aria-hidden="true"
                          ></ng-icon>
                          <span class="leading-5 text-sm">{{ d }}</span>
                        </li>
                      }
                    </ul>
                  </div>
                }
              </button>
            }
          </div>
        </div>
      }
    </div>

    <div class="mt-4">
      <label class="flex items-center gap-3 text-[18px] text-[#1f1f1f]">
        <hlm-checkbox formControlName="specialAssistEnabled"></hlm-checkbox>
        <span class="font-medium">ผู้โดยสารต้องการความช่วยเหลือพิเศษ</span>
      </label>
      @if (specialAssistEnabled) {
        <div class="space-y-2 p-2 text-[18px] text-[#3a3a3a]" formGroupName="specialAssist">
          <label class="flex items-center gap-4">
            <hlm-checkbox formControlName="visualImpairment"></hlm-checkbox>
            <span>ผู้บกพร่องทางสายตา/ตาบอด</span>
          </label>

          <label class="flex items-center gap-4">
            <hlm-checkbox formControlName="hearingImpairment"></hlm-checkbox>
            <span>ผู้บกพร่องทางการได้ยิน/หูหนวก</span>
          </label>

          <label class="flex items-center gap-4">
            <hlm-checkbox formControlName="monk"></hlm-checkbox>
            <span>พระภิกษุ</span>
          </label>

          <label class="flex items-center gap-4">
            <hlm-checkbox formControlName="nun"></hlm-checkbox>
            <span>แม่ชี</span>
          </label>

          <label class="flex items-center gap-4">
            <hlm-checkbox formControlName="pregnant"></hlm-checkbox>
            <span>สตรีตั้งครรภ์</span>
          </label>

          <label class="flex items-center gap-4">
            <hlm-checkbox formControlName="wheelchair"></hlm-checkbox>
            <span>รถเข็น วีลแชร์</span>
          </label>

          <label class="flex items-center gap-4">
            <hlm-checkbox formControlName="unaccompaniedMinor"></hlm-checkbox>
            <span>เด็กเดินทางคนเดียว</span>
          </label>

          <!-- ✅ Row: other checkbox -->
          <div class="flex items-center gap-4">
            <label class="flex items-center gap-4">
              <hlm-checkbox formControlName="other"></hlm-checkbox>
              <span>อื่นๆ</span>
            </label>

            <!-- ✅ input ต้องอยู่นอก formGroupName="specialAssist" -->
            <input
              hlmInput
              formControlName="specialAssistOther"
              placeholder="โปรดระบุ"
              class="flex-1 border-0 border-b !border-b-gray-800 !bg-white text-[18px] focus-visible:ring-0 focus-visible:outline-none"
              [class.opacity-50]="!otherAssistChecked"
            />
          </div>

          <div class="text-[18px] text-red-600">สามารถติดต่อเจ้าหน้าที่เพื่อสอบถาม โทร 1318</div>
        </div>
      }
    </div>

    <div class="mt-2 space-y-2 pb-2">
      @if (currentPassenger < passengerTabs.length) {
        <button
          type="submit"
          hlmBtn
          class="w-full !bg-transparent !border-0 !shadow-none !px-0 py-2 text-sm font-semibold text-[#1c1c1c] flex items-center justify-center gap-2"
        >
          <span class="underline decoration-2 underline-offset-4">{{ continueButtonText }}</span>
          <ng-icon name="lucideArrowRight" class="flex-none" size="18" aria-hidden="true"></ng-icon>
        </button>
      }
      <hlm-dialog #confirmDialog>
        <hlm-dialog-content
          *brnDialogContent="let _ctx"
          [showCloseButton]="true"
          class="max-w-[320px] p-4"
        >
          <div hlmDialogHeader>
            <h3 hlmDialogTitle class="text-left text-xl font-bold text-[#1f1f1f]">
              Review Passenger Details
            </h3>
            <p hlmDialogDescription class="text-left text-base text-[#5b5b5b]">
              Before proceeding, please ensure all passenger information is correct.
            </p>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <button
              type="button"
              hlmBtn
              variant="outline"
              class="w-full !bg-gray-300 !text-gray-600 rounded-[4px]"
              (click)="onReviewAgain(confirmDialog)"
            >
              Review Again
            </button>
            <button
              type="button"
              hlmBtn
              variant="outline"
              class="w-full !bg-[#ffd400] !border-black !text-[#1f1f1f] !hover:bg-[#ffd400] rounded-[4px]"
              (click)="onConfirmPassengers(confirmDialog)"
            >
              Confirm
            </button>
          </div>
        </hlm-dialog-content>
      </hlm-dialog>

      <button
        type="button"
        hlmBtn
        class="w-full rounded-[4px] bg-[#ffd400] py-3 text-sm font-semibold text-[#1f1f1f] disabled:bg-[#d4d4d4] disabled:text-[#666]"
        [disabled]="!canConfirm"
        (click)="onOpenConfirmDialog(confirmDialog)"
      >
        Confirm
      </button>
    </div>
  </form>
</div>
<app-bottom-sheet-select-sheet #bsSheet></app-bottom-sheet-select-sheet>
